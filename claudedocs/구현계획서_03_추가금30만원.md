# êµ¬í˜„ ê³„íšì„œ - ì¶”ê°€ê¸ˆ 30ë§Œì› í•­ëª© (AI ë¦¬ë·° ë°±ê·¸ë¼ìš´ë“œ ë³‘ë ¬ ì²˜ë¦¬)

## ğŸ“‹ ê°œìš”
- **í•­ëª©**: AI ë¦¬ë·° ìƒì„± ë°±ê·¸ë¼ìš´ë“œ ë³‘ë ¬ ì²˜ë¦¬ (ì¶”ì²œ)
- **ë¹„ìš©**: 30ë§Œì›
- **ì¹´í…Œê³ ë¦¬**: ì„±ëŠ¥ ê°œì„ 
- **íš¨ê³¼**: ì—…ë¬´ íš¨ìœ¨ 50~70% ê°œì„  (10ë¶„ â†’ 3~5ë¶„)

---

## ğŸ’¡ ì¶”ê°€ê¸ˆ ë°œìƒ ì´ìœ  (ë¹„ì „ë¬¸ê°€ìš©)

í˜„ì¬ ì¹´ì¹´ì˜¤ë§µ ë¦¬ë·° 50ê°œë¥¼ AIë¡œ ìƒì„±í•˜ë©´ ì•½ 10ë¶„ì´ ê±¸ë¦½ë‹ˆë‹¤. ì´ëŠ” ë¦¬ë·°ë¥¼ **ìˆœì°¨ì ìœ¼ë¡œ í•˜ë‚˜ì”©** ìƒì„±í•˜ê¸° ë•Œë¬¸ì…ë‹ˆë‹¤.

ìš”ì²­ì‚¬í•­ì€ **ì—¬ëŸ¬ ë¦¬ë·°ë¥¼ ë™ì‹œì— ë³‘ë ¬ë¡œ ìƒì„±**í•˜ëŠ” ì‹œìŠ¤í…œì…ë‹ˆë‹¤. ë§ˆì¹˜ 1ëª…ì´ 10ë¶„ ë™ì•ˆ ì¼í•˜ëŠ” ëŒ€ì‹ , 5ëª…ì´ ë™ì‹œì— 2ë¶„ì”© ì¼í•˜ëŠ” ê²ƒê³¼ ê°™ìŠµë‹ˆë‹¤.

ì´ë¥¼ ìœ„í•´ì„œëŠ”:
1. **ë°±ê·¸ë¼ìš´ë“œ ì‘ì—… í ì‹œìŠ¤í…œ** êµ¬ì¶• (ì‘ì—…ì„ ë‚˜ëˆ ì„œ ì²˜ë¦¬)
2. **ë³‘ë ¬ ì²˜ë¦¬ ë¡œì§** ê°œë°œ (5ê°œì”© ë¬¶ì–´ì„œ ë™ì‹œ ì‹¤í–‰)
3. **ì‹¤ì‹œê°„ ì§„í–‰ë¥  í‘œì‹œ** ê°œë°œ (ëª‡ ê°œ ì™„ë£Œí–ˆëŠ”ì§€ ë³´ì—¬ì£¼ê¸°)
4. **ì‘ì—… ì¤‘ë‹¨/ì¬ì‹œì‘** ê¸°ëŠ¥ ê°œë°œ (ë¬¸ì œ ë°œìƒ ì‹œ ëŒ€ì‘)

ì´ ëª¨ë“  ê²ƒì´ ìƒˆë¡œìš´ ì•„í‚¤í…ì²˜ ì„¤ê³„ì™€ ê°œë°œì´ í•„ìš”í•˜ë¯€ë¡œ ì¶”ê°€ê¸ˆì´ ë°œìƒí•©ë‹ˆë‹¤.

---

## ğŸ¯ í˜„ì¬ ì‹œìŠ¤í…œ ë¶„ì„

### í˜„ì¬ êµ¬ì¡° (ìˆœì°¨ ì²˜ë¦¬)

```typescript
// í˜„ì¬: ìˆœì°¨ì  AI ìƒì„± (ëŠë¦¼)
for (let i = 0; i < 50; i++) {
  const review = await generateAIReview(prompt);
  await saveReview(review);
  // 1ê°œë‹¹ 12ì´ˆ Ã— 50ê°œ = 600ì´ˆ (10ë¶„)
}
```

**ë¬¸ì œì **:
- 50ê°œ ë¦¬ë·° ìƒì„±ì— 10ë¶„ ì†Œìš”
- ê´€ë¦¬ìê°€ í™”ë©´ì„ ë– ë‚  ìˆ˜ ì—†ìŒ (ëŒ€ê¸° í•„ìš”)
- ì¤‘ê°„ì— ì˜¤ë¥˜ ë°œìƒ ì‹œ ì²˜ìŒë¶€í„° ë‹¤ì‹œ ì‹œì‘
- ë‹¤ë¥¸ ì—…ë¬´ë¥¼ í•  ìˆ˜ ì—†ìŒ

---

## ğŸš€ ê°œì„  ì‹œìŠ¤í…œ (ë³‘ë ¬ ë°±ê·¸ë¼ìš´ë“œ ì²˜ë¦¬)

### ìƒˆë¡œìš´ ì•„í‚¤í…ì²˜

```typescript
// ê°œì„ : ë°±ê·¸ë¼ìš´ë“œ ë³‘ë ¬ ì²˜ë¦¬ (ë¹ ë¦„)
async function generateReviewsInBackground(jobId, reviews) {
  // 5ê°œì”© ë°°ì¹˜ë¡œ ë‚˜ëˆ„ê¸°
  const batches = chunkArray(reviews, 5);

  for (const batch of batches) {
    // 5ê°œ ë™ì‹œ ìƒì„± (Promise.all)
    await Promise.all(
      batch.map(review => generateAIReview(review.prompt))
    );

    // ì§„í–‰ë¥  ì—…ë°ì´íŠ¸
    updateProgress(jobId, completed / total);
  }
}

// ë°±ê·¸ë¼ìš´ë“œì—ì„œ ì‹¤í–‰ (Non-blocking)
startBackgroundJob(generateReviewsInBackground);

// ê´€ë¦¬ìëŠ” ë‹¤ë¥¸ í˜ì´ì§€ë¡œ ì´ë™ ê°€ëŠ¥
// ì‹¤ì‹œê°„ìœ¼ë¡œ ì§„í–‰ë¥ ë§Œ í™•ì¸
```

**ì¥ì **:
- 50ê°œ ë¦¬ë·° ìƒì„±ì— 3~5ë¶„ ì†Œìš” (50~70% ê°œì„ )
- ê´€ë¦¬ìê°€ ë‹¤ë¥¸ ì—…ë¬´ ê°€ëŠ¥ (ë°±ê·¸ë¼ìš´ë“œ ì‹¤í–‰)
- ì˜¤ë¥˜ ë°œìƒ ì‹œ í•´ë‹¹ ë°°ì¹˜ë§Œ ì¬ì‹œë„
- ì‹¤ì‹œê°„ ì§„í–‰ë¥  í™•ì¸ ê°€ëŠ¥

---

## ğŸ“ êµ¬í˜„ ì„¤ê³„

### Phase 1: ë°±ê·¸ë¼ìš´ë“œ ì‘ì—… í ì‹œìŠ¤í…œ

#### Step 1: ì‘ì—… í…Œì´ë¸” ìƒì„±

```sql
-- ë°±ê·¸ë¼ìš´ë“œ ì‘ì—… í…Œì´ë¸”
CREATE TABLE background_jobs (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  type TEXT NOT NULL, -- 'ai_review_generation', 'bulk_upload', etc.
  status TEXT NOT NULL DEFAULT 'pending', -- 'pending', 'running', 'completed', 'failed', 'cancelled'

  -- ì‘ì—… ì •ë³´
  payload JSONB NOT NULL, -- ì‘ì—…ì— í•„ìš”í•œ ë°ì´í„°
  result JSONB, -- ì‘ì—… ê²°ê³¼

  -- ì§„í–‰ë¥ 
  total_items INT NOT NULL,
  completed_items INT DEFAULT 0,
  failed_items INT DEFAULT 0,
  progress_percentage DECIMAL(5,2) DEFAULT 0,

  -- ë©”íƒ€ë°ì´í„°
  created_by UUID REFERENCES users(id),
  created_at TIMESTAMPTZ DEFAULT NOW(),
  started_at TIMESTAMPTZ,
  completed_at TIMESTAMPTZ,

  -- ì—ëŸ¬ ì •ë³´
  error_message TEXT,
  retry_count INT DEFAULT 0,
  max_retries INT DEFAULT 3
);

-- ì‘ì—… ë¡œê·¸ í…Œì´ë¸”
CREATE TABLE background_job_logs (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  job_id UUID NOT NULL REFERENCES background_jobs(id) ON DELETE CASCADE,
  level TEXT NOT NULL, -- 'info', 'warning', 'error'
  message TEXT NOT NULL,
  metadata JSONB,
  created_at TIMESTAMPTZ DEFAULT NOW()
);

-- ì¸ë±ìŠ¤
CREATE INDEX idx_background_jobs_status ON background_jobs(status);
CREATE INDEX idx_background_jobs_type ON background_jobs(type);
CREATE INDEX idx_background_jobs_created_by ON background_jobs(created_by);
CREATE INDEX idx_job_logs_job_id ON background_job_logs(job_id);
```

#### Step 2: ì‘ì—… ìƒì„± API

```typescript
// app/api/admin/kakaomap/[id]/generate-ai-reviews/route.ts
export async function POST(
  request: Request,
  { params }: { params: { id: string } }
) {
  const { id: submissionId } = await params;
  const session = await getServerSession();

  // 1. ì ‘ìˆ˜ ì •ë³´ ì¡°íšŒ
  const { data: submission } = await supabase
    .from('kakaomap_submissions')
    .select('*, kakaomap_content(*)')
    .eq('id', submissionId)
    .single();

  if (!submission) {
    return Response.json({ error: 'ì ‘ìˆ˜ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.' }, { status: 404 });
  }

  // 2. ìƒì„±í•  ë¦¬ë·° ê°œìˆ˜ í™•ì¸
  const totalCount = submission.total_count;
  const existingCount = submission.kakaomap_content?.length || 0;
  const remainingCount = totalCount - existingCount;

  if (remainingCount <= 0) {
    return Response.json({ error: 'ì´ë¯¸ ëª¨ë“  ë¦¬ë·°ê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.' }, { status: 400 });
  }

  // 3. ë°±ê·¸ë¼ìš´ë“œ ì‘ì—… ìƒì„±
  const { data: job, error } = await supabase
    .from('background_jobs')
    .insert({
      type: 'ai_review_generation',
      status: 'pending',
      total_items: remainingCount,
      completed_items: 0,
      progress_percentage: 0,
      payload: {
        submission_id: submissionId,
        count: remainingCount,
        script: submission.script || '',
        place_name: submission.company_name,
      },
      created_by: session.user.id,
    })
    .select()
    .single();

  if (error) {
    return Response.json({ error: 'ì‘ì—… ìƒì„± ì‹¤íŒ¨' }, { status: 500 });
  }

  // 4. ë°±ê·¸ë¼ìš´ë“œ ì›Œì»¤ì— ì‘ì—… ì „ì†¡
  await triggerBackgroundWorker(job.id);

  return Response.json({
    success: true,
    job_id: job.id,
    message: 'ë°±ê·¸ë¼ìš´ë“œì—ì„œ ë¦¬ë·°ë¥¼ ìƒì„±í•˜ê³  ìˆìŠµë‹ˆë‹¤.',
  });
}
```

---

### Phase 2: ë°±ê·¸ë¼ìš´ë“œ ì›Œì»¤ êµ¬í˜„

#### Step 1: ì›Œì»¤ í”„ë¡œì„¸ìŠ¤

**Option A: Vercelì˜ ê²½ìš° - API Route + Polling**
```typescript
// app/api/workers/process-job/route.ts
export async function POST(request: Request) {
  const { job_id } = await request.json();

  try {
    // 1. ì‘ì—… ì¡°íšŒ
    const { data: job } = await supabase
      .from('background_jobs')
      .select('*')
      .eq('id', job_id)
      .single();

    if (!job || job.status !== 'pending') {
      return Response.json({ error: 'ìœ íš¨í•˜ì§€ ì•Šì€ ì‘ì—…' }, { status: 400 });
    }

    // 2. ì‘ì—… ì‹œì‘
    await supabase
      .from('background_jobs')
      .update({
        status: 'running',
        started_at: new Date().toISOString(),
      })
      .eq('id', job_id);

    // 3. ì‘ì—… íƒ€ì…ì— ë”°ë¼ ì²˜ë¦¬
    if (job.type === 'ai_review_generation') {
      await processAIReviewGeneration(job);
    }

    // 4. ì‘ì—… ì™„ë£Œ
    await supabase
      .from('background_jobs')
      .update({
        status: 'completed',
        completed_at: new Date().toISOString(),
        progress_percentage: 100,
      })
      .eq('id', job_id);

    return Response.json({ success: true });

  } catch (error) {
    // ì—ëŸ¬ ì²˜ë¦¬
    await supabase
      .from('background_jobs')
      .update({
        status: 'failed',
        error_message: error.message,
        completed_at: new Date().toISOString(),
      })
      .eq('id', job_id);

    return Response.json({ error: error.message }, { status: 500 });
  }
}
```

**Option B: Node.js í™˜ê²½ - BullMQ (ì¶”ì²œ)**
```typescript
// lib/queue/review-queue.ts
import { Queue, Worker } from 'bullmq';
import Redis from 'ioredis';

const connection = new Redis(process.env.REDIS_URL);

// í ìƒì„±
export const reviewQueue = new Queue('ai-review-generation', { connection });

// ì›Œì»¤ ìƒì„±
const worker = new Worker(
  'ai-review-generation',
  async (job) => {
    const { job_id } = job.data;
    await processAIReviewGeneration(job_id);
  },
  {
    connection,
    concurrency: 3, // ë™ì‹œì— 3ê°œ ì‘ì—… ì²˜ë¦¬
  }
);

// ì§„í–‰ë¥  ì—…ë°ì´íŠ¸
worker.on('progress', (job, progress) => {
  console.log(`Job ${job.id} is ${progress}% complete`);
});

// ì‘ì—… ì¶”ê°€
export async function addReviewGenerationJob(jobId: string) {
  await reviewQueue.add('generate-reviews', { job_id: jobId });
}
```

#### Step 2: AI ë¦¬ë·° ë³‘ë ¬ ìƒì„± ë¡œì§

```typescript
// lib/ai/parallel-review-generator.ts
async function processAIReviewGeneration(job: BackgroundJob) {
  const { submission_id, count, script, place_name } = job.payload;

  // 1. ë°°ì¹˜ í¬ê¸° ì„¤ì • (5ê°œì”© ë³‘ë ¬ ì²˜ë¦¬)
  const BATCH_SIZE = 5;
  const totalBatches = Math.ceil(count / BATCH_SIZE);

  // 2. ë¡œê·¸ ì‹œì‘
  await createJobLog(job.id, 'info', `ì´ ${count}ê°œ ë¦¬ë·° ìƒì„± ì‹œì‘`);

  let completedCount = 0;
  let failedCount = 0;

  // 3. ë°°ì¹˜ë³„ë¡œ ì²˜ë¦¬
  for (let batchIndex = 0; batchIndex < totalBatches; batchIndex++) {
    const batchStart = batchIndex * BATCH_SIZE;
    const batchEnd = Math.min(batchStart + BATCH_SIZE, count);
    const batchSize = batchEnd - batchStart;

    await createJobLog(
      job.id,
      'info',
      `ë°°ì¹˜ ${batchIndex + 1}/${totalBatches} ì²˜ë¦¬ ì¤‘ (${batchSize}ê°œ)`
    );

    // 4. ë°°ì¹˜ ë‚´ ë³‘ë ¬ ìƒì„±
    const batchPromises = [];

    for (let i = 0; i < batchSize; i++) {
      const reviewIndex = batchStart + i + 1;

      const promise = generateSingleReview({
        submission_id,
        script,
        place_name,
        review_index: reviewIndex,
      })
        .then((review) => {
          completedCount++;
          return { success: true, review };
        })
        .catch((error) => {
          failedCount++;
          createJobLog(
            job.id,
            'error',
            `ë¦¬ë·° ${reviewIndex} ìƒì„± ì‹¤íŒ¨: ${error.message}`
          );
          return { success: false, error };
        });

      batchPromises.push(promise);
    }

    // 5. ë°°ì¹˜ ì™„ë£Œ ëŒ€ê¸°
    const results = await Promise.all(batchPromises);

    // 6. ì§„í–‰ë¥  ì—…ë°ì´íŠ¸
    const progress = ((completedCount + failedCount) / count) * 100;

    await supabase
      .from('background_jobs')
      .update({
        completed_items: completedCount,
        failed_items: failedCount,
        progress_percentage: progress.toFixed(2),
      })
      .eq('id', job.id);

    // 7. ë°°ì¹˜ ì™„ë£Œ ë¡œê·¸
    const successCount = results.filter(r => r.success).length;
    await createJobLog(
      job.id,
      'info',
      `ë°°ì¹˜ ${batchIndex + 1} ì™„ë£Œ: ì„±ê³µ ${successCount}/${batchSize}, ì§„í–‰ë¥  ${progress.toFixed(1)}%`
    );

    // 8. Rate limiting (API ì œí•œ ë°©ì§€)
    if (batchIndex < totalBatches - 1) {
      await sleep(1000); // ë°°ì¹˜ ì‚¬ì´ 1ì´ˆ ëŒ€ê¸°
    }
  }

  // 9. ìµœì¢… ë¡œê·¸
  await createJobLog(
    job.id,
    'info',
    `ì‘ì—… ì™„ë£Œ: ì´ ${count}ê°œ ì¤‘ ì„±ê³µ ${completedCount}ê°œ, ì‹¤íŒ¨ ${failedCount}ê°œ`
  );

  return {
    completed: completedCount,
    failed: failedCount,
  };
}

// ë‹¨ì¼ ë¦¬ë·° ìƒì„±
async function generateSingleReview({
  submission_id,
  script,
  place_name,
  review_index,
}: {
  submission_id: string;
  script: string;
  place_name: string;
  review_index: number;
}) {
  // 1. AI í”„ë¡¬í”„íŠ¸ ìƒì„±
  const prompt = `
ë‹¹ì‹ ì€ ${place_name}ë¥¼ ë°©ë¬¸í•œ ê³ ê°ì…ë‹ˆë‹¤.
ë‹¤ìŒ ë‚´ìš©ì„ ë°”íƒ•ìœ¼ë¡œ ìì—°ìŠ¤ëŸ¬ìš´ ë¦¬ë·°ë¥¼ ì‘ì„±í•´ì£¼ì„¸ìš”:

${script}

ìš”êµ¬ì‚¬í•­:
- 100~150ì ë¶„ëŸ‰
- ìì—°ìŠ¤ëŸ½ê³  ì§„ì†”í•œ ë§íˆ¬
- êµ¬ì²´ì ì¸ ê²½í—˜ í¬í•¨
`;

  // 2. Gemini AI í˜¸ì¶œ
  const genAI = new GoogleGenerativeAI(process.env.GEMINI_API_KEY);
  const model = genAI.getGenerativeModel({ model: 'gemini-2.0-flash-exp' });

  const result = await model.generateContent(prompt);
  const reviewText = result.response.text();

  // 3. ë°ì´í„°ë² ì´ìŠ¤ ì €ì¥
  const { data: review, error } = await supabase
    .from('kakaomap_content')
    .insert({
      submission_id,
      review_text: reviewText,
      status: 'pending',
      created_by_ai: true,
    })
    .select()
    .single();

  if (error) throw error;

  return review;
}

// ì‘ì—… ë¡œê·¸ ìƒì„±
async function createJobLog(
  jobId: string,
  level: 'info' | 'warning' | 'error',
  message: string,
  metadata?: any
) {
  await supabase.from('background_job_logs').insert({
    job_id: jobId,
    level,
    message,
    metadata,
  });
}

// ìœ í‹¸ë¦¬í‹°: sleep
function sleep(ms: number) {
  return new Promise(resolve => setTimeout(resolve, ms));
}
```

---

### Phase 3: ì‹¤ì‹œê°„ ì§„í–‰ë¥  UI

#### Step 1: ì‘ì—… ì‹œì‘ ë²„íŠ¼

```typescript
// components/admin/kakaomap/ai-generation-button.tsx
'use client';

export function AIGenerationButton({ submissionId }: { submissionId: string }) {
  const [loading, setLoading] = useState(false);
  const [jobId, setJobId] = useState<string | null>(null);

  const startGeneration = async () => {
    setLoading(true);
    try {
      const res = await fetch(`/api/admin/kakaomap/${submissionId}/generate-ai-reviews`, {
        method: 'POST',
      });

      const data = await res.json();

      if (res.ok) {
        setJobId(data.job_id);
        toast.success('ë°±ê·¸ë¼ìš´ë“œì—ì„œ ë¦¬ë·°ë¥¼ ìƒì„±í•˜ê³  ìˆìŠµë‹ˆë‹¤.');
      } else {
        toast.error(data.error || 'ì‘ì—… ì‹œì‘ ì‹¤íŒ¨');
      }
    } finally {
      setLoading(false);
    }
  };

  return (
    <>
      <Button onClick={startGeneration} disabled={loading || jobId}>
        {loading ? 'ì‹œì‘ ì¤‘...' : jobId ? 'ìƒì„± ì¤‘...' : 'AI ë¦¬ë·° ì¼ê´„ ìƒì„±'}
      </Button>

      {jobId && <JobProgressMonitor jobId={jobId} />}
    </>
  );
}
```

#### Step 2: ì§„í–‰ë¥  ëª¨ë‹ˆí„° ì»´í¬ë„ŒíŠ¸

```typescript
// components/admin/kakaomap/job-progress-monitor.tsx
'use client';

export function JobProgressMonitor({ jobId }: { jobId: string }) {
  const { data: job, error } = useSWR(
    `/api/background-jobs/${jobId}`,
    fetcher,
    { refreshInterval: 2000 } // 2ì´ˆë§ˆë‹¤ í´ë§
  );

  if (error) return <div>ì§„í–‰ë¥  ì¡°íšŒ ì‹¤íŒ¨</div>;
  if (!job) return <div>ë¡œë”© ì¤‘...</div>;

  const isCompleted = job.status === 'completed';
  const isFailed = job.status === 'failed';
  const isRunning = job.status === 'running';

  return (
    <Card className="mt-4">
      <CardHeader>
        <CardTitle className="flex items-center justify-between">
          <span>AI ë¦¬ë·° ìƒì„± ì§„í–‰ë¥ </span>
          <Badge variant={isCompleted ? 'success' : isRunning ? 'default' : 'destructive'}>
            {job.status === 'pending' && 'ëŒ€ê¸° ì¤‘'}
            {job.status === 'running' && 'ì§„í–‰ ì¤‘'}
            {job.status === 'completed' && 'ì™„ë£Œ'}
            {job.status === 'failed' && 'ì‹¤íŒ¨'}
            {job.status === 'cancelled' && 'ì¤‘ë‹¨ë¨'}
          </Badge>
        </CardTitle>
      </CardHeader>
      <CardContent>
        <div className="space-y-4">
          {/* ì§„í–‰ë¥  ë°” */}
          <div>
            <div className="flex justify-between text-sm mb-2">
              <span>ì§„í–‰ë¥ </span>
              <span className="font-semibold">{job.progress_percentage}%</span>
            </div>
            <Progress value={job.progress_percentage} />
          </div>

          {/* í†µê³„ */}
          <div className="grid grid-cols-3 gap-4">
            <div className="text-center p-3 bg-gray-50 rounded-lg">
              <div className="text-2xl font-bold">{job.total_items}</div>
              <div className="text-sm text-gray-600">ì „ì²´</div>
            </div>
            <div className="text-center p-3 bg-green-50 rounded-lg">
              <div className="text-2xl font-bold text-green-600">{job.completed_items}</div>
              <div className="text-sm text-gray-600">ì™„ë£Œ</div>
            </div>
            <div className="text-center p-3 bg-red-50 rounded-lg">
              <div className="text-2xl font-bold text-red-600">{job.failed_items}</div>
              <div className="text-sm text-gray-600">ì‹¤íŒ¨</div>
            </div>
          </div>

          {/* ì‹œê°„ ì •ë³´ */}
          <div className="text-sm text-gray-600">
            <div className="flex justify-between mb-1">
              <span>ì‹œì‘ ì‹œê°„:</span>
              <span>{job.started_at ? formatTime(job.started_at) : '-'}</span>
            </div>
            {isRunning && (
              <div className="flex justify-between">
                <span>ê²½ê³¼ ì‹œê°„:</span>
                <span>{calculateElapsedTime(job.started_at)}</span>
              </div>
            )}
            {isCompleted && (
              <div className="flex justify-between">
                <span>ì™„ë£Œ ì‹œê°„:</span>
                <span>{formatTime(job.completed_at)}</span>
              </div>
            )}
          </div>

          {/* ì—ëŸ¬ ë©”ì‹œì§€ */}
          {isFailed && job.error_message && (
            <Alert variant="destructive">
              <AlertCircle className="h-4 w-4" />
              <AlertTitle>ì˜¤ë¥˜ ë°œìƒ</AlertTitle>
              <AlertDescription>{job.error_message}</AlertDescription>
            </Alert>
          )}

          {/* ì‘ì—… ë¡œê·¸ */}
          <JobLogsSection jobId={jobId} />

          {/* ì•¡ì…˜ ë²„íŠ¼ */}
          <div className="flex gap-2">
            {isRunning && (
              <Button variant="destructive" size="sm" onClick={() => cancelJob(jobId)}>
                ì‘ì—… ì¤‘ë‹¨
              </Button>
            )}
            {isFailed && (
              <Button variant="outline" size="sm" onClick={() => retryJob(jobId)}>
                ì¬ì‹œë„
              </Button>
            )}
            {isCompleted && (
              <Button variant="outline" size="sm" onClick={() => router.refresh()}>
                ê²°ê³¼ í™•ì¸
              </Button>
            )}
          </div>
        </div>
      </CardContent>
    </Card>
  );
}
```

#### Step 3: ì‘ì—… ë¡œê·¸ ì„¹ì…˜

```typescript
// components/admin/kakaomap/job-logs-section.tsx
export function JobLogsSection({ jobId }: { jobId: string }) {
  const { data: logs } = useSWR(`/api/background-jobs/${jobId}/logs`, fetcher, {
    refreshInterval: 5000, // 5ì´ˆë§ˆë‹¤ í´ë§
  });

  const [expanded, setExpanded] = useState(false);

  if (!logs || logs.length === 0) return null;

  return (
    <div className="border rounded-lg">
      <button
        className="w-full px-4 py-2 flex items-center justify-between hover:bg-gray-50"
        onClick={() => setExpanded(!expanded)}
      >
        <span className="font-semibold">ì‘ì—… ë¡œê·¸ ({logs.length})</span>
        {expanded ? <ChevronUp className="h-4 w-4" /> : <ChevronDown className="h-4 w-4" />}
      </button>

      {expanded && (
        <div className="p-4 border-t max-h-64 overflow-y-auto">
          <div className="space-y-2">
            {logs.map((log: any) => (
              <div
                key={log.id}
                className={`text-sm p-2 rounded ${
                  log.level === 'error'
                    ? 'bg-red-50 text-red-800'
                    : log.level === 'warning'
                    ? 'bg-yellow-50 text-yellow-800'
                    : 'bg-gray-50 text-gray-800'
                }`}
              >
                <div className="flex items-start gap-2">
                  <span className="text-xs text-gray-500">{formatTime(log.created_at)}</span>
                  <span className="flex-1">{log.message}</span>
                </div>
              </div>
            ))}
          </div>
        </div>
      )}
    </div>
  );
}
```

---

### Phase 4: ì‘ì—… ê´€ë¦¬ API

```typescript
// app/api/background-jobs/[id]/route.ts
export async function GET(
  request: Request,
  { params }: { params: { id: string } }
) {
  const { id } = await params;

  const { data: job } = await supabase
    .from('background_jobs')
    .select('*')
    .eq('id', id)
    .single();

  return Response.json(job);
}

// app/api/background-jobs/[id]/logs/route.ts
export async function GET(
  request: Request,
  { params }: { params: { id: string } }
) {
  const { id } = await params;

  const { data: logs } = await supabase
    .from('background_job_logs')
    .select('*')
    .eq('job_id', id)
    .order('created_at', { ascending: false })
    .limit(50);

  return Response.json(logs);
}

// app/api/background-jobs/[id]/cancel/route.ts
export async function POST(
  request: Request,
  { params }: { params: { id: string } }
) {
  const { id } = await params;

  await supabase
    .from('background_jobs')
    .update({ status: 'cancelled' })
    .eq('id', id);

  return Response.json({ success: true });
}

// app/api/background-jobs/[id]/retry/route.ts
export async function POST(
  request: Request,
  { params }: { params: { id: string } }
) {
  const { id } = await params;

  // ì¬ì‹œë„ ì¹´ìš´íŠ¸ ì¦ê°€ ë° ìƒíƒœ ì´ˆê¸°í™”
  await supabase
    .from('background_jobs')
    .update({
      status: 'pending',
      retry_count: supabase.rpc('increment', { x: 1, field: 'retry_count' }),
      error_message: null,
    })
    .eq('id', id);

  // ì›Œì»¤ íŠ¸ë¦¬ê±°
  await triggerBackgroundWorker(id);

  return Response.json({ success: true });
}
```

---

### Phase 5: ì‘ì—… ëª©ë¡ ê´€ë¦¬ í˜ì´ì§€ (ê´€ë¦¬ì)

```typescript
// app/admin/background-jobs/page.tsx
export default async function BackgroundJobsPage() {
  const { data: jobs } = await supabase
    .from('background_jobs')
    .select('*')
    .order('created_at', { ascending: false })
    .limit(50);

  return (
    <div className="container mx-auto py-8">
      <div className="flex justify-between items-center mb-6">
        <h1 className="text-3xl font-bold">ë°±ê·¸ë¼ìš´ë“œ ì‘ì—… ê´€ë¦¬</h1>
        <div className="flex gap-2">
          <Badge variant="outline">
            ì§„í–‰ ì¤‘: {jobs?.filter(j => j.status === 'running').length}
          </Badge>
          <Badge variant="outline">
            ëŒ€ê¸° ì¤‘: {jobs?.filter(j => j.status === 'pending').length}
          </Badge>
        </div>
      </div>

      <Tabs defaultValue="all">
        <TabsList>
          <TabsTrigger value="all">ì „ì²´</TabsTrigger>
          <TabsTrigger value="running">ì§„í–‰ ì¤‘</TabsTrigger>
          <TabsTrigger value="completed">ì™„ë£Œ</TabsTrigger>
          <TabsTrigger value="failed">ì‹¤íŒ¨</TabsTrigger>
        </TabsList>

        <TabsContent value="all">
          <JobsTable data={jobs} />
        </TabsContent>

        <TabsContent value="running">
          <JobsTable data={jobs?.filter(j => j.status === 'running')} />
        </TabsContent>

        <TabsContent value="completed">
          <JobsTable data={jobs?.filter(j => j.status === 'completed')} />
        </TabsContent>

        <TabsContent value="failed">
          <JobsTable data={jobs?.filter(j => j.status === 'failed')} />
        </TabsContent>
      </Tabs>
    </div>
  );
}
```

---

## ğŸ“Š ì„±ëŠ¥ ë¹„êµ

### í˜„ì¬ (ìˆœì°¨ ì²˜ë¦¬)
```
ì‘ì—… ì‹œê°„: 50ê°œ Ã— 12ì´ˆ = 600ì´ˆ (10ë¶„)
ë³‘ë ¬ì„±: 1ê°œì”© ìˆœì°¨ ì²˜ë¦¬
ê´€ë¦¬ì: í™”ë©´ ëŒ€ê¸° í•„ìš”
ì˜¤ë¥˜ ì²˜ë¦¬: ì „ì²´ ì¬ì‹œì‘
```

### ê°œì„  (ë³‘ë ¬ ë°±ê·¸ë¼ìš´ë“œ)
```
ì‘ì—… ì‹œê°„: (50ê°œ / 5ê°œ ë°°ì¹˜) Ã— 12ì´ˆ = 120ì´ˆ + Î± = 3~5ë¶„
ë³‘ë ¬ì„±: 5ê°œì”© ë™ì‹œ ì²˜ë¦¬
ê´€ë¦¬ì: ë‹¤ë¥¸ ì—…ë¬´ ê°€ëŠ¥
ì˜¤ë¥˜ ì²˜ë¦¬: ë°°ì¹˜ ë‹¨ìœ„ ì¬ì‹œë„
```

**ê°œì„  íš¨ê³¼**:
- âš¡ ì‘ì—… ì‹œê°„: 10ë¶„ â†’ 3~5ë¶„ (50~70% ë‹¨ì¶•)
- ğŸ¯ ìƒì‚°ì„±: ëŒ€ê¸° ì‹œê°„ ì œê±°ë¡œ ì—…ë¬´ íš¨ìœ¨ ëŒ€í­ í–¥ìƒ
- ğŸ›¡ï¸ ì•ˆì •ì„±: ë¶€ë¶„ ì‹¤íŒ¨ ì‹œ ì¬ì‹œë„ ê°€ëŠ¥
- ğŸ“Š ê°€ì‹œì„±: ì‹¤ì‹œê°„ ì§„í–‰ë¥  ë° ë¡œê·¸ í™•ì¸

---

## âœ… êµ¬í˜„ ì²´í¬ë¦¬ìŠ¤íŠ¸

### ë°ì´í„°ë² ì´ìŠ¤
- [ ] background_jobs í…Œì´ë¸” ìƒì„±
- [ ] background_job_logs í…Œì´ë¸” ìƒì„±
- [ ] ì¸ë±ìŠ¤ ìƒì„±
- [ ] ë§ˆì´ê·¸ë ˆì´ì…˜ íŒŒì¼ ì‘ì„±

### ë°±ê·¸ë¼ìš´ë“œ ì‹œìŠ¤í…œ
- [ ] ì‘ì—… í ì‹œìŠ¤í…œ êµ¬ì¶• (BullMQ ë˜ëŠ” API Route)
- [ ] ì›Œì»¤ í”„ë¡œì„¸ìŠ¤ êµ¬í˜„
- [ ] ë³‘ë ¬ ì²˜ë¦¬ ë¡œì§ ê°œë°œ
- [ ] ì§„í–‰ë¥  ì—…ë°ì´íŠ¸ ë©”ì»¤ë‹ˆì¦˜
- [ ] ì—ëŸ¬ í•¸ë“¤ë§ ë° ì¬ì‹œë„ ë¡œì§

### AI ìƒì„± ë¡œì§
- [ ] ë°°ì¹˜ ë¶„í•  ë¡œì§ (5ê°œì”©)
- [ ] Promise.all ë³‘ë ¬ ì‹¤í–‰
- [ ] Gemini API í˜¸ì¶œ ìµœì í™”
- [ ] Rate limiting êµ¬í˜„
- [ ] ë¦¬ë·° ì €ì¥ ë¡œì§

### API êµ¬í˜„
- [ ] POST /api/admin/kakaomap/[id]/generate-ai-reviews - ì‘ì—… ìƒì„±
- [ ] POST /api/workers/process-job - ì›Œì»¤ ì‹¤í–‰
- [ ] GET /api/background-jobs/[id] - ì‘ì—… ì¡°íšŒ
- [ ] GET /api/background-jobs/[id]/logs - ë¡œê·¸ ì¡°íšŒ
- [ ] POST /api/background-jobs/[id]/cancel - ì‘ì—… ì¤‘ë‹¨
- [ ] POST /api/background-jobs/[id]/retry - ì‘ì—… ì¬ì‹œë„

### UI ì»´í¬ë„ŒíŠ¸
- [ ] AIGenerationButton - ì‘ì—… ì‹œì‘ ë²„íŠ¼
- [ ] JobProgressMonitor - ì§„í–‰ë¥  ëª¨ë‹ˆí„°
- [ ] JobLogsSection - ì‘ì—… ë¡œê·¸
- [ ] ê´€ë¦¬ì ì‘ì—… ëª©ë¡ í˜ì´ì§€

### ê¸°ëŠ¥
- [ ] ë°±ê·¸ë¼ìš´ë“œ ì‘ì—… ì‹¤í–‰
- [ ] ì‹¤ì‹œê°„ ì§„í–‰ë¥  í‘œì‹œ
- [ ] ì‘ì—… ë¡œê·¸ ê¸°ë¡
- [ ] ì‘ì—… ì¤‘ë‹¨ ê¸°ëŠ¥
- [ ] ì‘ì—… ì¬ì‹œë„ ê¸°ëŠ¥

### í…ŒìŠ¤íŠ¸
- [ ] 50ê°œ ë¦¬ë·° ìƒì„± ì„±ëŠ¥ í…ŒìŠ¤íŠ¸
- [ ] ë³‘ë ¬ ì²˜ë¦¬ ì •í™•ì„± í…ŒìŠ¤íŠ¸
- [ ] ì§„í–‰ë¥  ì—…ë°ì´íŠ¸ í…ŒìŠ¤íŠ¸
- [ ] ì˜¤ë¥˜ ì²˜ë¦¬ ë° ì¬ì‹œë„ í…ŒìŠ¤íŠ¸
- [ ] ì‘ì—… ì¤‘ë‹¨ í…ŒìŠ¤íŠ¸
- [ ] ë™ì‹œ ë‹¤ì¤‘ ì‘ì—… í…ŒìŠ¤íŠ¸

### ìµœì¢… ê²€ì¦
- [ ] 10ë¶„ â†’ 3~5ë¶„ ì„±ëŠ¥ ê°œì„  í™•ì¸
- [ ] ë°±ê·¸ë¼ìš´ë“œ ì‹¤í–‰ í™•ì¸ (í™”ë©´ ì´ë™ ê°€ëŠ¥)
- [ ] ì‹¤ì‹œê°„ ì§„í–‰ë¥  ì •í™•ì„± í™•ì¸
- [ ] ì—ëŸ¬ ë³µêµ¬ ë©”ì»¤ë‹ˆì¦˜ ê²€ì¦
- [ ] ì „ì²´ ë¹Œë“œ ì„±ê³µ
- [ ] ë°°í¬ ì¤€ë¹„ ì™„ë£Œ

---

## ğŸ¯ ê¸°ëŒ€ íš¨ê³¼

### ì •ëŸ‰ì  íš¨ê³¼
- **ì‘ì—… ì‹œê°„ ë‹¨ì¶•**: 10ë¶„ â†’ 3~5ë¶„ (50~70% ê°œì„ )
- **ë™ì‹œ ì²˜ë¦¬ ëŠ¥ë ¥**: 1ê°œ â†’ 5ê°œ (5ë°° í–¥ìƒ)
- **ê´€ë¦¬ì ëŒ€ê¸° ì‹œê°„**: 10ë¶„ â†’ 0ë¶„ (100% ì œê±°)

### ì •ì„±ì  íš¨ê³¼
- **ì—…ë¬´ íš¨ìœ¨**: ê´€ë¦¬ìê°€ ë‹¤ë¥¸ ì—…ë¬´ ë³‘í–‰ ê°€ëŠ¥
- **ì‚¬ìš©ì ê²½í—˜**: ì¦‰ì‹œ í”¼ë“œë°± ë° ì‹¤ì‹œê°„ ì§„í–‰ë¥ 
- **ì‹œìŠ¤í…œ ì•ˆì •ì„±**: ë¶€ë¶„ ì‹¤íŒ¨ ì‹œ ì¬ì‹œë„ë¡œ ë³µêµ¬ë ¥ í–¥ìƒ
- **í™•ì¥ì„±**: í–¥í›„ ë‹¤ë¥¸ ë°°ì¹˜ ì‘ì—…ì—ë„ ì ìš© ê°€ëŠ¥

### ROI (íˆ¬ì ëŒ€ë¹„ íš¨ê³¼)
- **ê°œë°œ ë¹„ìš©**: 30ë§Œì›
- **ì‹œê°„ ì ˆê°**: ì ‘ìˆ˜ 1ê±´ë‹¹ 5~7ë¶„ ì ˆì•½
- **ì›” 100ê±´ ì ‘ìˆ˜ ì‹œ**: 500~700ë¶„ ì ˆì•½ (ì•½ 8~12ì‹œê°„)
- **ì—°ê°„**: 6,000~8,400ë¶„ ì ˆì•½ (ì•½ 100~140ì‹œê°„)

â†’ **ë§¤ìš° ë†’ì€ íˆ¬ì ëŒ€ë¹„ íš¨ê³¼**
